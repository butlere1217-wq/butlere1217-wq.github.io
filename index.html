<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Virtual Rain Gauge ‚Äî Dual API v2</title>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f6f8fb;
    --card:#ffffff;
    --muted:#667085;
    --text:#0f172a;
    --accent:#2563eb;
    --radius:16px;
    --shadow:0 10px 30px rgba(15,23,42,0.06);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:linear-gradient(180deg,#f8fbff, #eef3f9);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{text-align:center;padding:20px 16px 10px}
  header h1{margin:0 0 6px;font-size:1.25rem;color:#0b3b69}
  header .sub{margin:0;color:var(--muted);font-size:.9rem}
  main{max-width:980px;margin:0 auto;padding:10px 12px 24px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}
  .inputs .grid{display:grid;grid-template-columns:1fr;gap:10px}
  label{display:block;font-size:.85rem;color:#334155;margin-bottom:6px}
  input[type=text],input[type=date]{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fbfdff;font-size:1rem}
  input:focus{outline:2px solid rgba(37,99,235,.15);border-color:#c7d2fe}
  .btn-row{display:flex;gap:10px;margin-top:10px}
  button{flex:1;padding:12px 14px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;font-size:1rem;cursor:pointer}
  button.alt{background:#10b981}
  button:active{transform:translateY(1px)}
  .hint{margin:.5rem 2px 0;color:var(--muted);font-size:.85rem}
  .table-wrap{overflow:auto}
  table{width:100%;min-width:760px;border-collapse:collapse}
  th,td{padding:10px 8px;text-align:center;border-bottom:1px solid #eef2f7}
  th{background:#e9eff7;color:#0b2545;font-weight:800;position:sticky;top:0}
  .row-label{font-weight:700;text-align:left;padding-left:10px;color:#0b2545;width:180px}
  .chart-card{padding:10px 12px}
  .chart-head{display:flex;align-items:baseline;justify-content:space-between;gap:8px;margin:6px 2px 10px}
  .chart-head h2{margin:0;font-size:1rem;color:#0b3b69}
  .legend-note{color:var(--muted);font-size:.85rem}
  footer{padding:18px 12px 28px;text-align:center;color:var(--muted);font-size:.85rem}
</style>
</head>
<body>
  <header>
    <h1>üåßÔ∏è Virtual Rain Gauge</h1>
    <p class="sub">Accurate short-term via Forecast API, long-term via Archive API. Units: inches.</p>
  </header>
  <main>
    <section class="card inputs">
      <div class="grid">
        <div>
          <label for="manualAddress">Manual location (optional)</label>
          <input id="manualAddress" type="text" placeholder="e.g., City, State" />
        </div>
        <div>
          <label for="startDate">Custom range start</label>
          <input id="startDate" type="date" />
        </div>
        <div>
          <label for="endDate">Custom range end</label>
          <input id="endDate" type="date" />
        </div>
      </div>
      <div class="btn-row">
        <button id="btnApply">Apply</button>
        <button id="btnClear" class="alt">Clear</button>
      </div>
      <p class="hint">Leave dates empty for default 24h/7d/30d/365d view.</p>
    </section>
    <section class="card">
      <div class="table-wrap">
        <table id="summaryTable">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
    <section class="card chart-card">
      <div class="chart-head">
        <h2 id="chartTitle">Daily rainfall ‚Äî last 30 days</h2>
        <div class="legend-note" id="legendNote"></div>
      </div>
      <canvas id="rainChart"></canvas>
    </section>
  </main>
  <footer>
    Data: Open‚ÄëMeteo APIs & OpenStreetMap Nominatim
  </footer>
<script>
const MM_TO_IN = 0.0393701;
const FIXED = [
  { id:'home', label:'Bay Village', lat:41.4848, lon:-81.9221 },
  { id:'findlay', label:'Findlay', lat:41.04278, lon:-83.64222 },
  { id:'richfield', label:'Richfield', lat:41.2335, lon:-81.6260 }
];
let manual = null;
let manualLabel = '';
let chart = null;
let customTotals = null;
const fmt = n => (Math.round(n*100)/100).toFixed(2);
const todayStr = () => new Date().toISOString().slice(0,10);
const dateShift = days => { const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); };
const sum = arr => arr.reduce((a,b)=>a+(b||0),0);
const toInches = mm => (mm||0)*MM_TO_IN;
async function fetchRecent(lat, lon){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&past_days=8&hourly=precipitation&timezone=auto`;
  const r = await fetch(url);
  const j = await r.json();
  const times = j.hourly?.time || [];
  const prec = j.hourly?.precipitation || [];
  const now = new Date();
  const filtered = [];
  for(let i=0;i<times.length;i++){
    if(new Date(times[i]) <= now){
      filtered.push(toInches(prec[i]));
    }
  }
  const last24 = sum(filtered.slice(-24));
  const last168 = sum(filtered.slice(-168));
  return { last24, last7: last168 };
}
async function fetchDailyArchive(lat, lon, start, end){
  const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&daily=precipitation_sum&timezone=auto`;
  const r = await fetch(url);
  const d = await r.json();
  const times = d.daily?.time || [];
  const mm = d.daily?.precipitation_sum || [];
  return { time: times, inches: mm.map(toInches) };
}
async function geocode(addr){
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}&addressdetails=1`;
  const r = await fetch(url);
  const j = await r.json();
  if(!j.length) throw new Error('Address not found');
  const a = j[0];
  const ad = a.address || {};
  const labelParts = [];
  if(ad.city) labelParts.push(ad.city);
  else if(ad.town) labelParts.push(ad.town);
  if(ad.state) labelParts.push(ad.state);
  const label = labelParts.join(', ') || a.display_name;
  return { label, lat:parseFloat(a.lat), lon:parseFloat(a.lon) };
}
function mergeTotals(short, longSeries){
  return {
    'Last 24 Hours': short.last24,
    'Last 7 Days': short.last7,
    'Last 30 Days': sum(longSeries.inches.slice(-30)),
    'Last 365 Days': sum(longSeries.inches.slice(-365))
  };
}
function renderTable(totalsByLoc, customTotals){
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  thead.innerHTML = '';
  tbody.innerHTML = '';
  const headRow = document.createElement('tr');
  headRow.innerHTML = `<th class="row-label">Period</th>` +
    `<th>Bay Village</th>` +
    `<th>Findlay</th>` +
    `<th>Richfield</th>` +
    (manual ? `<th>${manualLabel}</th>` : '');
  thead.appendChild(headRow);
  ['Last 24 Hours','Last 7 Days','Last 30 Days','Last 365 Days'].forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p}</td>` +
      `<td>${fmt(totalsByLoc.home?.[p] || 0)}</td>` +
      `<td>${fmt(totalsByLoc.findlay?.[p] || 0)}</td>` +
      `<td>${fmt(totalsByLoc.richfield?.[p] || 0)}</td>` +
      (manual ? `<td>${fmt(totalsByLoc.manual?.[p] || 0)}</td>` : '');
    tbody.appendChild(tr);
  });
  if(customTotals){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>Custom Range</td>` +
      `<td>${fmt(customTotals.home || 0)}</td>` +
      `<td>${fmt(customTotals.findlay || 0)}</td>` +
      `<td>${fmt(customTotals.richfield || 0)}</td>` +
      (manual ? `<td>${fmt(customTotals.manual || 0)}</td>` : '');
    tbody.appendChild(tr);
  }
}
function renderChart(labels, seriesByLoc, title){
  const ctx = document.getElementById('rainChart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets:[
        {label:'Bay Village', data:seriesByLoc.home, borderColor:'#027AFF', backgroundColor:'rgba(2,122,255,0.3)', fill:true, tension:0.25},
        {label:'Findlay', data:seriesByLoc.findlay, borderColor:'#00C853', backgroundColor:'rgba(0,200,83,0.3)', fill:true, tension:0.25},
        {label:'Richfield', data:seriesByLoc.richfield, borderColor:'#FF9F40', backgroundColor:'rgba(255,159,64,0.3)', fill:true, tension:0.25},
        ...(manual ? [{label: manualLabel, data:seriesByLoc.manual, borderColor:'#7B61FF', backgroundColor:'rgba(123,97,255,0.3)', fill:true, tension:0.25}] : [])
      ]
    }
  });
  document.getElementById('chartTitle').textContent = title;
}
async function loadData(customStart=null, customEnd=null){
  const end365 = todayStr();
  const start365 = dateShift(-365);
  const start30 = dateShift(-30);
  const totalsByLoc = {};
  const chartData = {};
  let labels = [];
  customTotals = null;
  const locs = [...FIXED];
  if(manual) locs.push({id:'manual', label: manualLabel, lat:manual.lat, lon:manual.lon});
  for(const loc of locs){
    const short = await fetchRecent(loc.lat, loc.lon);
    const long365 = await fetchDailyArchive(loc.lat, loc.lon, start365, end365);
    totalsByLoc[loc.id] = mergeTotals(short, long365);
    if(customStart && customEnd){
      const customSeries = await fetchDailyArchive(loc.lat, loc.lon, customStart, customEnd);
      chartData[loc.id] = customSeries.inches;
      if(!labels.length) labels = customSeries.time;
      if(!customTotals) customTotals = {};
      customTotals[loc.id] = sum(customSeries.inches);
    } else {
      const long30 = await fetchDailyArchive(loc.lat, loc.lon, start30, end365);
      chartData[loc.id] = long30.inches;
      if(!labels.length) labels = long30.time;
    }
  }
  renderTable(totalsByLoc, customTotals);
  const title = customStart && customEnd ? `Daily rainfall ‚Äî ${customStart} to ${customEnd}` : 'Daily rainfall ‚Äî last 30 days';
  renderChart(labels, chartData, title);
}
document.getElementById('btnApply').addEventListener('click', async () => {
  const addr = document.getElementById('manualAddress').value.trim();
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  if(addr){
    try{
      manual = await geocode(addr);
      manualLabel = manual.label;
    }catch(e){ alert(e.message); return; }
  } else { manual = null; manualLabel = ''; }
  loadData(start || null, end || null);
});
document.getElementById('btnClear').addEventListener('click', () => {
  manual = null; manualLabel = ''; document.getElementById('manualAddress').value='';
  document.getElementById('startDate').value=''; document.getElementById('endDate').value='';
  loadData();
});
window.addEventListener('DOMContentLoaded', () => loadData());
</script>
</body>
</html>