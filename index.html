<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Virtual Rain Gauge</title>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f6f8fb;
    --card:#ffffff;
    --muted:#667085;
    --text:#0f172a;
    --accent:#2563eb;
    --radius:16px;
    --shadow:0 10px 30px rgba(15,23,42,0.06);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:linear-gradient(180deg,#f8fbff, #eef3f9);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{text-align:center;padding:20px 16px 10px}
  header h1{margin:0 0 6px;font-size:1.25rem;color:#0b3b69}
  header .sub{margin:0;color:var(--muted);font-size:.9rem}
  main{max-width:980px;margin:0 auto;padding:10px 12px 24px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}
  .inputs .grid{display:grid;grid-template-columns:1fr;gap:10px}
  label{display:block;font-size:.85rem;color:#334155;margin-bottom:6px}
  input[type=text],input[type=date]{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fbfdff;font-size:1rem}
  input:focus{outline:2px solid rgba(37,99,235,.15);border-color:#c7d2fe}
  .btn-row{display:flex;gap:10px;margin-top:10px}
  button{flex:1;padding:12px 14px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;font-size:1rem;cursor:pointer}
  button.alt{background:#10b981}
  button:active{transform:translateY(1px)}
  .hint{margin:.5rem 2px 0;color:var(--muted);font-size:.85rem}

  .table-wrap{overflow:auto}
  table{width:100%;min-width:760px;border-collapse:collapse}
  th,td{padding:10px 8px;text-align:center;border-bottom:1px solid #eef2f7}
  th{background:#f9fbff;color:#0b2545;font-weight:800;position:sticky;top:0}
  .row-label{font-weight:700;text-align:left;padding-left:10px;color:#0b2545;width:180px}
  th.loc-home{background:linear-gradient(90deg,rgba(2,122,255,.08),transparent)}
  th.loc-findlay{background:linear-gradient(90deg,rgba(0,200,83,.08),transparent)}
  th.loc-richfield{background:linear-gradient(90deg,rgba(255,159,64,.12),transparent)}
  th.loc-manual{background:linear-gradient(90deg,rgba(123,97,255,.12),transparent)}
  td.emph{font-weight:700}

  .chart-card{padding:10px 12px}
  .chart-head{display:flex;align-items:baseline;justify-content:space-between;gap:8px;margin:6px 2px 10px}
  .chart-head h2{margin:0;font-size:1rem;color:#0b3b69}
  .legend-note{color:var(--muted);font-size:.85rem}

  footer{padding:18px 12px 28px;text-align:center;color:var(--muted);font-size:.85rem}

  @media (min-width:640px){
    .inputs .grid{grid-template-columns:2fr 1fr 1fr}
    header h1{font-size:1.4rem}
  }
</style>
</head>
<body>
  <header>
    <h1>üåßÔ∏è Virtual Rain Gauge</h1>
    <p class="sub">Three saved locations + optional manual compare. Units: inches.</p>
  </header>

  <main>
    <section class="card inputs">
      <div class="grid">
        <div>
          <label for="manualAddress">Manual location (optional)</label>
          <input id="manualAddress" type="text" placeholder="e.g., 123 Main St, City, ST" />
        </div>
        <div>
          <label for="startDate">Custom range (start)</label>
          <input id="startDate" type="date" />
        </div>
        <div>
          <label for="endDate">Custom range (end)</label>
          <input id="endDate" type="date" />
        </div>
      </div>
      <div class="btn-row">
        <button id="btnApply">Apply</button>
        <button id="btnClear" class="alt">Clear</button>
      </div>
      <p class="hint">Tip: leave dates empty to compare the defaults (last 24h / 7d / 30d / 365d). Entering dates switches the chart to that range.</p>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table id="summaryTable" aria-live="polite">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <section class="card chart-card">
      <div class="chart-head">
        <h2 id="chartTitle">Daily rainfall ‚Äî last 30 days</h2>
        <div class="legend-note">Comparing Bay Village, Findlay, Richfield<span id="legendManual" style="display:none;">, <span id="legendManualName"></span></span></div>
      </div>
      <canvas id="rainChart" aria-label="Rainfall comparison chart" role="img"></canvas>
    </section>
  </main>

  <footer>
    <div>Data: Open‚ÄëMeteo (archive API). Geocoding: OpenStreetMap Nominatim.</div>
  </footer>

<script>
const MM_TO_IN = 0.0393701;

// Exact preferred coordinates
const FIXED = [
  { id:'home', label:'Bay Village', address:'387 Bates Dr, Bay Village, OH', lat:41.4848, lon:-81.9221 },
  { id:'findlay', label:'Findlay', address:'2003 Cobblestone Dr, Findlay, OH', lat:41.04278, lon:-83.64222 },
  { id:'richfield', label:'Richfield', address:'3447 Revere Rd, Richfield, OH', lat:41.2335, lon:-81.6260 }
];

let manual = null; // {label, lat, lon}
let manualLabel = ''; // label to show in table & legend
let chart = null;

// Helpers
const fmt = n => (Math.round(n*100)/100).toFixed(2);
const todayStr = () => new Date().toISOString().slice(0,10);
const dateShift = (days) => { const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); };
const normalizeInches = (mmArr=[]) => mmArr.map(v => (v??0) * MM_TO_IN);
const sumWindow = (arr=[], n) => arr.slice(-n).reduce((a,b)=>a+b,0);

// API
async function fetchDailySeries(lat, lon, start, end){
  const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&daily=precipitation_sum&timezone=auto`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Weather API error');
  const d = await r.json();
  if(!d.daily || !d.daily.precipitation_sum) throw new Error('No precip data');
  return { time:d.daily.time, inches: normalizeInches(d.daily.precipitation_sum) };
}

async function geocode(addr){
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}&addressdetails=1`;
  const r = await fetch(url, { headers:{ 'Accept-Language':'en' } });
  if(!r.ok) throw new Error('Geocoding failed');
  const j = await r.json();
  if(!j.length) throw new Error('Address not found');
  const a = j[0]; const ad = a.address || {};
  const labelParts = [];
  if(ad.house_number && ad.road) labelParts.push(`${ad.house_number} ${ad.road}`);
  else if(ad.road) labelParts.push(ad.road);
  if(ad.city) labelParts.push(ad.city); else if(ad.town) labelParts.push(ad.town);
  if(ad.state) labelParts.push(ad.state);
  const label = labelParts.join(', ') || a.display_name;
  return { label, lat:parseFloat(a.lat), lon:parseFloat(a.lon) };
}

// Compute standard totals from a 365-day series
function standardTotals(series){
  const n = series.inches.length;
  const last = n ? series.inches[n-1] : 0;
  return {
    'Last 24 Hours': last,
    'Last 7 Days': sumWindow(series.inches, 7),
    'Last 30 Days': sumWindow(series.inches, 30),
    'Last 365 Days': sumWindow(series.inches, 365)
  };
}

// Render table: periods down the first column, locations across the top
function renderTable(totalsByLoc, showCustom, customTotals){
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  thead.innerHTML = ''; tbody.innerHTML = '';

  const headRow = document.createElement('tr');
  headRow.innerHTML = `
    <th class="row-label">Period</th>
    <th class="loc-home">Bay Village</th>
    <th class="loc-findlay">Findlay</th>
    <th class="loc-richfield">Richfield</th>
    ${manual ? `<th class="loc-manual">${manualLabel || 'Manual'}</th>` : ''}
  `;
  thead.appendChild(headRow);

  const periods = ['Last 24 Hours','Last 7 Days','Last 30 Days','Last 365 Days'];
  if(showCustom) periods.push('Custom Range');

  for(const p of periods){
    const tr = document.createElement('tr');
    const v = (loc, isCustom=false) => {
      if(isCustom) return customTotals?.[loc] !== undefined ? fmt(customTotals[loc]) : '-';
      const t = totalsByLoc[loc]?.[p];
      return typeof t === 'number' ? fmt(t) : '-';
    };
    tr.innerHTML = `
      <td class="row-label">${p}</td>
      <td class="emph">${p==='Custom Range'?v('home',true):v('home')}</td>
      <td class="emph">${p==='Custom Range'?v('findlay',true):v('findlay')}</td>
      <td class="emph">${p==='Custom Range'?v('richfield',true):v('richfield')}</td>
      ${manual ? `<td class="emph">${p==='Custom Range'?v('manual',true):v('manual')}</td>` : ''}
    `;
    tbody.appendChild(tr);
  }
}

// Chart helpers
function makeGradient(ctx, color){
  const g = ctx.createLinearGradient(0,0,0,240);
  const map = {
    blue:['rgba(2,122,255,0.45)','rgba(2,122,255,0)'],
    green:['rgba(0,200,83,0.35)','rgba(0,200,83,0)'],
    orange:['rgba(255,159,64,0.35)','rgba(255,159,64,0)'],
    purple:['rgba(123,97,255,0.35)','rgba(123,97,255,0)']
  };
  const [c1,c2] = map[color];
  g.addColorStop(0,c1); g.addColorStop(1,c2);
  return g;
}

function renderChart(labels, seriesByLoc){
  const ctx = document.getElementById('rainChart').getContext('2d');
  if(chart) chart.destroy();
  const datasets = [];
  if(seriesByLoc.home) datasets.push({label:'Bay Village', data:seriesByLoc.home, borderColor:'#027AFF', backgroundColor:makeGradient(ctx,'blue')});
  if(seriesByLoc.findlay) datasets.push({label:'Findlay', data:seriesByLoc.findlay, borderColor:'#00C853', backgroundColor:makeGradient(ctx,'green')});
  if(seriesByLoc.richfield) datasets.push({label:'Richfield', data:seriesByLoc.richfield, borderColor:'#FF9F40', backgroundColor:makeGradient(ctx,'orange')});
  if(seriesByLoc.manual) datasets.push({label: manualLabel || 'Manual', data:seriesByLoc.manual, borderColor:'#7B61FF', backgroundColor:makeGradient(ctx,'purple')});
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets: datasets.map(d=>({...d, fill:true, tension:.25, pointRadius:2, borderWidth:2})) },
    options:{
      responsive:true,
      interaction:{ mode:'index', intersect:false },
      plugins:{ legend:{ position:'top' } },
      scales:{ y:{ title:{ display:true, text:'Daily rainfall (in)' } } }
    }
  });
}

// Initial load: show table totals and last-30-days chart for the 3 fixed locations
async function loadInitial(){
  renderTable({}, false, null);
  const end365 = todayStr();
  const start365 = dateShift(-365);
  const end30 = end365;
  const start30 = dateShift(-30);

  const totalsByLoc = {};
  const last30 = {};
  let labels = [];

  for(const loc of FIXED){
    try{
      const s365 = await fetchDailySeries(loc.lat, loc.lon, start365, end365);
      totalsByLoc[loc.id] = standardTotals(s365);
      const s30 = await fetchDailySeries(loc.lat, loc.lon, start30, end30);
      last30[loc.id] = s30.inches;
      if(labels.length===0) labels = s30.time;
    }catch(e){ console.warn('Load failed for', loc.label, e); }
  }

  renderTable(totalsByLoc, false, null);
  document.getElementById('chartTitle').textContent = 'Daily rainfall ‚Äî last 30 days';
  renderChart(labels, last30);
  document.getElementById('legendManual').style.display = 'none';
}

// Apply manual location and/or custom date range
async function apply(){
  const addr = document.getElementById('manualAddress').value.trim();
  const sd = document.getElementById('startDate').value;
  const ed = document.getElementById('endDate').value;
  const wantCustom = !!(sd && ed);

  // Resolve manual location (if provided)
  manual = null;
  manualLabel = '';
  if(addr){
    try { 
      manual = await geocode(addr);
      manualLabel = manual.label;
    }
    catch(e){ alert(e.message || 'Manual address lookup failed'); }
  }
  const legendManual = document.getElementById('legendManual');
  const legendManualName = document.getElementById('legendManualName');
  if(manual){
    legendManual.style.display = '';
    legendManualName.textContent = manualLabel;
  }else{
    legendManual.style.display = 'none';
    legendManualName.textContent = '';
  }

  // Table: always include standard periods from last 365d
  const end365 = todayStr();
  const start365 = dateShift(-365);
  const totalsByLoc = {};

  // Fetch totals for fixed
  for(const loc of FIXED){
    try{
      const s365 = await fetchDailySeries(loc.lat, loc.lon, start365, end365);
      totalsByLoc[loc.id] = standardTotals(s365);
    }catch(e){}
  }
  // Manual totals
  if(manual){
    try{
      const s365m = await fetchDailySeries(manual.lat, manual.lon, start365, end365);
      totalsByLoc.manual = standardTotals(s365m);
    }catch(e){}
  }

  // Chart window (custom or default last 30 days)
  let chartStart, chartEnd, chartTitle;
  if(wantCustom){ chartStart = sd; chartEnd = ed; chartTitle = `Daily rainfall ‚Äî ${sd} ‚Üí ${ed}`; }
  else { chartEnd = todayStr(); chartStart = dateShift(-30); chartTitle = 'Daily rainfall ‚Äî last 30 days'; }

  const seriesByLoc = {}; let labels = [];
  for(const loc of FIXED){
    try{
      const s = await fetchDailySeries(loc.lat, loc.lon, chartStart, chartEnd);
      seriesByLoc[loc.id] = s.inches;
      if(labels.length===0) labels = s.time;
    }catch(e){}
  }
  if(manual){
    try{
      const sm = await fetchDailySeries(manual.lat, manual.lon, chartStart, chartEnd);
      seriesByLoc.manual = sm.inches;
    }catch(e){}
  }

  // If custom range, compute custom totals for the Custom Range row (and round to 2 decimals)
  let customTotals = null;
  if(wantCustom){
    customTotals = {};
    customTotals.home = (seriesByLoc.home||[]).reduce((a,b)=>a+b,0);
    customTotals.findlay = (seriesByLoc.findlay||[]).reduce((a,b)=>a+b,0);
    customTotals.richfield = (seriesByLoc.richfield||[]).reduce((a,b)=>a+b,0);
    if(manual) customTotals.manual = (seriesByLoc.manual||[]).reduce((a,b)=>a+b,0);
  }

  renderTable(totalsByLoc, wantCustom, customTotals);
  document.getElementById('chartTitle').textContent = chartTitle;
  renderChart(labels, seriesByLoc);
}

function clearAll(){
  document.getElementById('manualAddress').value='';
  document.getElementById('startDate').value='';
  document.getElementById('endDate').value='';
  manual = null;
  manualLabel = '';
  const legendManual = document.getElementById('legendManual');
  const legendManualName = document.getElementById('legendManualName');
  legendManual.style.display = 'none';
  legendManualName.textContent = '';
  loadInitial();
}

document.getElementById('btnApply').addEventListener('click', apply);
document.getElementById('btnClear').addEventListener('click', clearAll);
window.addEventListener('DOMContentLoaded', loadInitial);
</script>
</body>
</html>
